@model ECommerceMVC.ViewModels.RegisterVM
@{
    ViewData["Title"] = "Đăng ký";
}

<div class="container-fluid py-5">
    <div class="container py-5">
        <h1 class="mb-4">Đăng ký Thành viên</h1>

        <form asp-action="DangKy" enctype="multipart/form-data">
            <div class="row">
                <div class="row">

                    <!-- Mã khách hàng -->
                    <div class="col-md-12 col-lg-6">
                        <div class="form-item w-100">
                            <label asp-for="MaKh" class="form-label my-3"></label><sup>*</sup>
                            <input asp-for="MaKh" class="form-control" />
                            <span asp-validation-for="MaKh" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Mật khẩu -->
                    <div class="col-md-12 col-lg-6">
                        <label asp-for="MatKhau" class="form-label my-3"></label><sup>*</sup>
                        <input asp-for="MatKhau" class="form-control" />
                        <span asp-validation-for="MatKhau" class="text-danger"></span>
                    </div>

                    <!-- Họ tên -->
                    <div class="form-item">
                        <label asp-for="HoTen" class="form-label my-3"></label><sup>*</sup>
                        <input asp-for="HoTen" class="form-control" />
                        <span asp-validation-for="HoTen" class="text-danger"></span>
                    </div>

                    <!-- Giới tính -->
                    <div class="form-check my-3">
                        <input asp-for="GioiTinh" class="form-check-input" />
                        <label class="form-check-label">Nam?</label>
                    </div>

                    <!-- Ngày sinh -->
                    <div class="form-item">
                        <label asp-for="NgaySinh" class="form-label my-3"></label>
                        <input asp-for="NgaySinh" class="form-control" />
                        <span asp-validation-for="NgaySinh" class="text-danger"></span>
                    </div>

                    <!-- Địa chỉ -->
                    <div class="form-item">
                        <label asp-for="DiaChi" class="form-label my-3"></label><sup>*</sup>
                        <input asp-for="DiaChi" class="form-control" />
                        <span asp-validation-for="DiaChi" class="text-danger"></span>
                    </div>

                    <!-- Điện thoại -->
                    <div class="form-item">
                        <label asp-for="DienThoai" class="form-label my-3"></label><sup>*</sup>
                        <input asp-for="DienThoai" class="form-control" />
                        <span asp-validation-for="DienThoai" class="text-danger"></span>
                    </div>

                    <!-- Email -->
                    <div class="form-item">
                        <label asp-for="Email" class="form-label my-3"></label><sup>*</sup>
                        <input asp-for="Email" class="form-control" />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>

                    <!-- Hình -->
                    <div class="form-item">
                        <label class="form-label my-3">Hình đại diện</label>
                        <input type="file" name="Hinh" class="form-control" />
                    </div>

                    <!-- ===== NEWSLETTER SECTION (FIX ĐẦY ĐỦ) ===== -->
                    <div class="form-item mt-4">
                        <div class="card border-primary">
                            <div class="card-body" style="background-color: #f8f9fa;">
                                <h5 class="card-title text-primary">
                                    <i class="fas fa-envelope me-2"></i> Nhận thông tin khuyến mãi
                                </h5>

                                <!-- ✅ FIX 1: Checkbox chính với value="true" khi checked -->
                                <div class="form-check">
                                    <input type="checkbox"
                                           class="form-check-input"
                                           id="DangKyNhanTin"
                                           name="DangKyNhanTin"
                                           value="true"
                                           checked />
                                    <label class="form-check-label" for="DangKyNhanTin">
                                        <strong>Đăng ký nhận bản tin</strong>
                                    </label>
                                </div>

                                <small class="text-muted d-block mt-2">
                                    Nhận email về sản phẩm mới, khuyến mãi và voucher đặc biệt.
                                </small>

                                <!-- ✅ FIX 2: Preferences với NAME attributes -->
                                <div id="newsletterPreferences" class="mt-3 ps-4">
                                    <p class="mb-2"><small><strong>Tôi muốn nhận:</strong></small></p>

                                    <div class="form-check">
                                        <input type="checkbox"
                                               class="form-check-input preference-checkbox"
                                               id="NhanSanPhamMoi"
                                               name="NhanSanPhamMoi"
                                               value="true"
                                               checked />
                                        <label class="form-check-label" for="NhanSanPhamMoi">
                                            <small>Sản phẩm mới</small>
                                        </label>
                                    </div>

                                    <div class="form-check">
                                        <input type="checkbox"
                                               class="form-check-input preference-checkbox"
                                               id="NhanKhuyenMai"
                                               name="NhanKhuyenMai"
                                               value="true"
                                               checked />
                                        <label class="form-check-label" for="NhanKhuyenMai">
                                            <small>Chương trình khuyến mãi</small>
                                        </label>
                                    </div>

                                    <div class="form-check">
                                        <input type="checkbox"
                                               class="form-check-input preference-checkbox"
                                               id="NhanVoucher"
                                               name="NhanVoucher"
                                               value="true"
                                               checked />
                                        <label class="form-check-label" for="NhanVoucher">
                                            <small>Voucher & ưu đãi</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ===== END NEWSLETTER ===== -->

                </div>

                <!-- Submit -->
                <div class="row g-4 text-center align-items-center justify-content-center pt-4">
                    <button type="submit"
                            class="btn border-secondary py-3 px-4 text-uppercase w-100 text-primary">
                        <i class="fas fa-user-plus me-2"></i> Đăng ký
                    </button>

                    <div class="mt-3">
                        <span>Đã có tài khoản? </span>
                        <a asp-controller="KhachHang" asp-action="DangNhap" class="text-primary">
                            Đăng nhập ngay
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- ✅ FIX 3: JavaScript xử lý show/hide preferences -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mainCheckbox = document.getElementById('DangKyNhanTin');
        const preferencesDiv = document.getElementById('newsletterPreferences');
        const preferenceCheckboxes = document.querySelectorAll('.preference-checkbox');

        // Toggle preferences visibility
        mainCheckbox.addEventListener('change', function() {
            if (this.checked) {
                preferencesDiv.style.display = 'block';
            } else {
                preferencesDiv.style.display = 'none';
                // ✅ Uncheck all preferences when main checkbox is unchecked
                preferenceCheckboxes.forEach(cb => cb.checked = false);
            }
        });

        // ✅ Nếu user bỏ check tất cả preferences, tự động bỏ check main checkbox
        preferenceCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const anyChecked = Array.from(preferenceCheckboxes).some(cb => cb.checked);
                if (!anyChecked) {
                    mainCheckbox.checked = false;
                    preferencesDiv.style.display = 'none';
                }
            });
        });
    });
</script>

<style>
    .card-body {
        background-color: #f8f9fa;
    }

    #newsletterPreferences {
        border-left: 3px solid #0d6efd;
        padding-left: 15px;
    }

    .preference-checkbox {
        cursor: pointer;
    }

    .form-check-label {
        cursor: pointer;
    }
</style>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
